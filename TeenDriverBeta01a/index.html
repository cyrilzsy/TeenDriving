<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/hopscotch/0.3.1/css/hopscotch.css">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hopscotch/0.3.1/js/hopscotch.js"></script>
<script src="video_functions.js"></script>
<script src="tokens_and_IDs.js"></script>
<script src="callFunction.js"></script>

<link rel="stylesheet" href="styles.css">

<script>
	var mediaStart     = '<div class="media-left media-middle" style="padding-left:';
	var mediaEnd       = 'class="media-object" style="width:40px"></div><div class="media-body" style="padding-left:20px"><div style="padding:15px; color:black;"';
	var mediaEndForm   = 'class="media-object" style="width:40px"></div><div class="media-body" style="padding-left:20px" id="media-end-form"><div style="padding:15px; color:black;"';
	var mediaLeftAunt  = mediaStart + '30px"><img src="Elder image.png"' + mediaEnd + 'class="speech-bubble-aunt">';
	var mediaLeftMe    = mediaStart + ' 0px"><img src= "Girl image.png"' + mediaEnd + 'class="speech-bubble-me">';
	var chatBreak      = "</div></div><hr>";
	var mediaLeftForm  = mediaStart + ' 0px"><img src="Girl image.png" id="image-form"' + mediaEndForm + 'class="speech-bubble-me" id="speech-form">';
	var speechObj = "";

	function clickMe(element) {
		$("#input").val(element.value);
		send();
	}

	function RandomNumber() {
	    var a = Math.floor(Math.random() * 10);
	    var str = "Next coures please!";
	    $("#input").val(str + a);
	    send();
	}

    var inputbox0 = '<form autocomplete="on" id="myForm" onsubmit="send()">' +
			'<input type="text" style="width:100%" id="input" name="input" autocomplete="on" autofocus>' +
		'</form>';
	// var inputbox0 = '<p id="inputHeader">Input</p>' +
	// 					'<form autocomplete="on" onsubmit="return ajaxit();" id="myForm" target="the_iframe">' +
	// 						'<input type="text" style="width:100%" id="input" name="input" autocomplete="on">' +
	// 						'<input id="submit_button" type="submit" onclick="send();hideInputBox();" value="Submit">' +
	// 					'</form>' +
	// 					'<iframe id="the_iframe" name="the_iframe" src="javascript:false" class="hidden"></iframe>';

	function sendToDialogFlow(text_in) {
		var input = "";
		var clickAreaResponse = '';
		$.ajax({
			type:        "POST",
			url:          baseUrl + "query/",
			contentType: "application/json; charset=utf-8",
			dataType:    "json",
			headers: {
				         "Authorization": "Bearer " + accessToken,
			},
			data:         JSON.stringify({
				query:    text_in,
				lang:    "en",
				contexts:[
				],
				sessionId: "0123456789ti",
			}),

			success: function(data) {
		 		let data_speech = data.result.speech;
				var speechSplit = splitStr(data_speech);
				var speech = speechSplit.text.replace(/yyy/g,"{").replace(/zzz/g,"}");
				var speechJSON = speechSplit.JSON.replace(/yyy/g,"{").replace(/zzz/g,"}");
				if (speechJSON.length>0) {
					try {
						speechObj = JSON.parse(speechJSON);
						console.log(speechObj);
						let tasks = speechObj.tasks;
						console.log(tasks);
						for (iTask=0; iTask<tasks.length; iTask++) {
							let task = tasks[iTask];
							console.log('task ' + iTask + ' of ' + tasks.length);
							console.log(task);
							let taskType = Object.getOwnPropertyNames(task)[0];
							console.log('taskType: ' + taskType);
							if (taskType=='callFunction') {
								input = callFunction(task,clickAreaResponse);
							}
						}
					}
					catch(err) {
						console.log(speech);
						console.log(err);
					}
				}
				setDialogBox(false,speech,text_in,input);
		 		setResponse(JSON.stringify(data, undefined, 2));
			},
			error: function(jqXHR) {
  				setResponse(JSON.stringify(jqXHR, undefined, 2));
			}
		});
  		setResponse("Loading...");	
	}

	function send(text="",start=false) {
		if (start) {
			let inputbox = '<p id="inputHeader">' + text + '</p>' + inputbox0;
			setDialogBox(start,'','','begin',inputbox);
		} else {
			var text_in = $("#input").val(); // get input text
		    $('#speech-form').remove(); // get rid of the old form and other HTML elements
		    $('#image-form').remove();
		    $('#media-end-form').remove();
		    sendToDialogFlow(text_in);
		}
	}

	function setDialogBox(start,speech,text_in,input,inputbox=inputbox0) {
	    let response  = mediaLeftForm + inputbox;
	    if (!start) {
	    	response += chatBreak + mediaLeftAunt + speech + chatBreak + mediaLeftMe + text_in;
		} else {
		}
		response += "</div></div>";
	    $('#dialog').prepend(response);
		$("#input").val(input);
		$('#input').focus();
 		$("#dialog").scrollTop(0);

		let dialogWidth = parseInt($("#dialog")[0].clientWidth,10);
		let bubbles     = document.getElementsByClassName('speech-bubble-me');
		bubbles[bubbles.length - 1].style.width = dialogWidth - 120 + 'px';
		bubbles         = document.getElementsByClassName('speech-bubble-aunt');
		bubbles[bubbles.length - 1].style.width = dialogWidth - 120 + 'px';		
	}

	function setResponse(val) {                                // generic function to set the response
		// $("#response").text(val);                           // doesn't work when using sendIntent
		document.getElementById("response").value = val;
	}

	function splitStr(string) {
	    var object = string.split("#####");
	    var text = object[0];
	    var JSON = "";
	    if (object.length>1) {
		    JSON = object[1];
		};
	    return {text: text, JSON: JSON};
	}

	$(window).resize(function () {
		getwh();
	})

	$(document).ready(function() {
	    var video = document.getElementById("video");
		$('#video').on("loadeddata", function () {
			getwh();
			console.log('loadeddata');
		});
		getwh();
		send("Type begin:",true);
		$('#input').focus();
		$("#input").keypress(function(event) {
			if (event.which == 13) {
		    	$('#submit_button').click(); 
				event.preventDefault();
				send();
			}
		});
	});
</script>
</head>

<body>
    <div class="container-fluid">
    	<div class="row">
	    	<div class="col-sm-6" style="padding: 0px" id="video_div">
				<video id="video" width="100%">
			    	<source type="video/webm" src="28560.webm" id="videoSource">
			    	<source type="video/ogg" src="28560.ogg">
					Your browser does not support HTML video.
				</video>
				<div id="clickAreas" style="position: absolute; left:0px; top:0px">
				</div>
			</div>
			<div class="col-sm-6" style="padding: 0px">
		    	<div class="col" id="dialog">
				</div>
			</div>
		</div>
	</div>

	<hr>

	<!--<p id="inputHeader">Input (enter "begin" below to start or restart this mini-draft-chatbot):</p>-->

	<!--<form autocomplete="on" onsubmit="return ajaxit();" id="myForm" target="the_iframe">-->
		<!--<input type="text" style="width:100%" id="input" name="input" autocomplete="on"></input>-->
	    <!--<button id="submit_button" type="submit" class="hidden"></button>-->
	<!--</form>-->

	<!--<iframe id="the_iframe" name="the_iframe" src="javascript:false" class="hidden"></iframe>-->

	<br><br>

	<p><hr>Response from Dialogflow (ignore this technical form of chatbot dialog):</p>
	<textarea class="form-control" rows="20" style="width:100%" id="response"></textarea>
</body>
</html>